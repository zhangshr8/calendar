<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>🔧 OAuth测试页面</h1>
    
    <div class="card">
        <h2>1. 基础信息检查</h2>
        <div id="basic-info"></div>
        <button onclick="checkBasicInfo()">检查基础信息</button>
    </div>

    <div class="card">
        <h2>2. OAuth配置检查</h2>
        <div id="oauth-config"></div>
        <button onclick="checkOAuthConfig()">检查OAuth配置</button>
    </div>

    <div class="card">
        <h2>3. 登录测试</h2>
        <div id="login-test"></div>
        <button onclick="testLogin()">测试GitHub登录</button>
        <button onclick="testManualAuth()">手动测试授权</button>
    </div>

    <div class="card">
        <h2>4. 网络连接测试</h2>
        <div id="network-test"></div>
        <button onclick="testNetwork()">测试网络连接</button>
    </div>

    <div class="card">
        <h2>5. 调试信息</h2>
        <div id="debug-info"></div>
        <button onclick="showDebugInfo()">显示调试信息</button>
    </div>

    <script>
        // 配置信息
        const GITHUB_CONFIG = {
            clientId: 'Ov23lipRjGjVWDKrIQze',
            redirectUri: 'https://zhangshr8.github.io/calendar',
            scope: 'repo'
        };

        // 日志函数
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML += `<div class="${type}">${message}</div>`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // 检查基础信息
        function checkBasicInfo() {
            clearLog('basic-info');
            log('basic-info', '🔍 检查基础信息...', 'info');
            
            // 检查当前URL
            log('basic-info', `当前URL: ${window.location.href}`, 'info');
            
            // 检查URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (code) {
                log('basic-info', `✅ 发现授权码: ${code.substring(0, 10)}...`, 'success');
            } else if (error) {
                log('basic-info', `❌ 发现错误: ${error}`, 'error');
                const errorDesc = urlParams.get('error_description');
                if (errorDesc) {
                    log('basic-info', `错误描述: ${decodeURIComponent(errorDesc)}`, 'error');
                }
            } else {
                log('basic-info', 'ℹ️ 未发现授权码或错误', 'info');
            }
            
            // 检查localStorage
            const token = localStorage.getItem('github_token');
            const user = localStorage.getItem('github_user');
            
            if (token) {
                log('basic-info', '✅ 找到GitHub token', 'success');
            } else {
                log('basic-info', '❌ 未找到GitHub token', 'error');
            }
            
            if (user) {
                log('basic-info', '✅ 找到用户信息', 'success');
            } else {
                log('basic-info', '❌ 未找到用户信息', 'error');
            }
        }

        // 检查OAuth配置
        function checkOAuthConfig() {
            clearLog('oauth-config');
            log('oauth-config', '🔍 检查OAuth配置...', 'info');
            
            log('oauth-config', `Client ID: ${GITHUB_CONFIG.clientId}`, 'info');
            log('oauth-config', `Redirect URI: ${GITHUB_CONFIG.redirectUri}`, 'info');
            log('oauth-config', `Scope: ${GITHUB_CONFIG.scope}`, 'info');
            
            // 验证配置
            if (!GITHUB_CONFIG.clientId || GITHUB_CONFIG.clientId === 'YOUR_CLIENT_ID') {
                log('oauth-config', '❌ Client ID未配置', 'error');
            } else {
                log('oauth-config', '✅ Client ID已配置', 'success');
            }
            
            if (!GITHUB_CONFIG.redirectUri || GITHUB_CONFIG.redirectUri === 'YOUR_REDIRECT_URI') {
                log('oauth-config', '❌ Redirect URI未配置', 'error');
            } else {
                log('oauth-config', '✅ Redirect URI已配置', 'success');
            }
        }

        // 测试登录
        function testLogin() {
            clearLog('login-test');
            log('login-test', '🔍 测试GitHub登录...', 'info');
            
            // 构建OAuth URL
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CONFIG.clientId}&redirect_uri=${encodeURIComponent(GITHUB_CONFIG.redirectUri)}&scope=${GITHUB_CONFIG.scope}`;
            
            log('login-test', `OAuth URL: ${authUrl}`, 'info');
            log('login-test', '点击下面的链接手动测试:', 'info');
            
            const link = document.createElement('a');
            link.href = authUrl;
            link.textContent = '点击这里进行GitHub授权';
            link.target = '_blank';
            link.style.display = 'block';
            link.style.margin = '10px 0';
            link.style.padding = '10px';
            link.style.background = '#007bff';
            link.style.color = 'white';
            link.style.textDecoration = 'none';
            link.style.borderRadius = '5px';
            link.style.textAlign = 'center';
            
            document.getElementById('login-test').appendChild(link);
        }

        // 手动测试授权
        function testManualAuth() {
            clearLog('login-test');
            log('login-test', '🔍 手动测试授权流程...', 'info');
            
            // 检查是否有授权码
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                log('login-test', `✅ 发现授权码: ${code}`, 'success');
                testTokenExchange(code);
            } else {
                log('login-test', '❌ 未发现授权码，请先进行授权', 'error');
                log('login-test', '请点击"测试GitHub登录"按钮获取授权码', 'info');
            }
        }

        // 测试token交换
        async function testTokenExchange(code) {
            log('login-test', '🔍 测试token交换...', 'info');
            
            try {
                const response = await fetch('https://github.com/login/oauth/access_token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: GITHUB_CONFIG.clientId,
                        client_secret: 'cc563e335e3f23ecdd19c7d4eaae65534483c486',
                        code: code,
                        redirect_uri: GITHUB_CONFIG.redirectUri
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('login-test', '✅ Token交换成功', 'success');
                    log('login-test', `Token: ${data.access_token.substring(0, 10)}...`, 'success');
                    log('login-test', `Token类型: ${data.token_type}`, 'success');
                    log('login-test', `Scope: ${data.scope}`, 'success');
                    
                    // 测试获取用户信息
                    await testUserInfo(data.access_token);
                } else {
                    log('login-test', `❌ Token交换失败: ${data.error}`, 'error');
                    if (data.error_description) {
                        log('login-test', `错误描述: ${data.error_description}`, 'error');
                    }
                }
            } catch (error) {
                log('login-test', `❌ Token交换请求失败: ${error.message}`, 'error');
            }
        }

        // 测试获取用户信息
        async function testUserInfo(token) {
            log('login-test', '🔍 测试获取用户信息...', 'info');
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    log('login-test', '✅ 用户信息获取成功', 'success');
                    log('login-test', `用户名: ${user.login}`, 'success');
                    log('login-test', `姓名: ${user.name || '未设置'}`, 'success');
                    log('login-test', `邮箱: ${user.email || '未设置'}`, 'success');
                    log('login-test', `头像: ${user.avatar_url}`, 'success');
                } else {
                    log('login-test', `❌ 用户信息获取失败: ${response.status}`, 'error');
                }
            } catch (error) {
                log('login-test', `❌ 用户信息请求失败: ${error.message}`, 'error');
            }
        }

        // 测试网络连接
        async function testNetwork() {
            clearLog('network-test');
            log('network-test', '🔍 测试网络连接...', 'info');
            
            // 测试GitHub API
            try {
                const response = await fetch('https://api.github.com/rate_limit');
                if (response.ok) {
                    log('network-test', '✅ GitHub API连接正常', 'success');
                    const data = await response.json();
                    log('network-test', `API限制: ${data.rate.remaining}/${data.rate.limit}`, 'info');
                } else {
                    log('network-test', `❌ GitHub API连接失败: ${response.status}`, 'error');
                }
            } catch (error) {
                log('network-test', `❌ 网络连接失败: ${error.message}`, 'error');
            }
            
            // 测试OAuth端点
            try {
                const response = await fetch('https://github.com/login/oauth/authorize', {
                    method: 'HEAD'
                });
                if (response.ok) {
                    log('network-test', '✅ OAuth端点连接正常', 'success');
                } else {
                    log('network-test', `❌ OAuth端点连接失败: ${response.status}`, 'error');
                }
            } catch (error) {
                log('network-test', `❌ OAuth端点连接失败: ${error.message}`, 'error');
            }
        }

        // 显示调试信息
        function showDebugInfo() {
            clearLog('debug-info');
            log('debug-info', '🔍 调试信息:', 'info');
            log('debug-info', `User Agent: ${navigator.userAgent}`, 'info');
            log('debug-info', `当前时间: ${new Date().toISOString()}`, 'info');
            log('debug-info', `页面URL: ${window.location.href}`, 'info');
            log('debug-info', `页面协议: ${window.location.protocol}`, 'info');
            log('debug-info', `页面主机: ${window.location.host}`, 'info');
            log('debug-info', `页面路径: ${window.location.pathname}`, 'info');
            
            // 显示所有URL参数
            const urlParams = new URLSearchParams(window.location.search);
            log('debug-info', 'URL参数:', 'info');
            for (const [key, value] of urlParams) {
                log('debug-info', `  ${key}: ${value}`, 'info');
            }
            
            // 显示localStorage内容
            log('debug-info', 'LocalStorage内容:', 'info');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                if (key.includes('github') || key.includes('token')) {
                    log('debug-info', `  ${key}: ${value.substring(0, 20)}...`, 'info');
                }
            }
        }

        // 页面加载时自动检查
        window.onload = function() {
            checkBasicInfo();
            checkOAuthConfig();
            
            // 检查是否有错误参数
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error) {
                alert(`OAuth错误: ${error}\n描述: ${urlParams.get('error_description') || '无'}`);
            }
        };
    </script>
</body>
</html>