<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuthæµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ OAuthæµ‹è¯•é¡µé¢</h1>
    
    <div class="card">
        <h2>1. åŸºç¡€ä¿¡æ¯æ£€æŸ¥</h2>
        <div id="basic-info"></div>
        <button onclick="checkBasicInfo()">æ£€æŸ¥åŸºç¡€ä¿¡æ¯</button>
    </div>

    <div class="card">
        <h2>2. OAuthé…ç½®æ£€æŸ¥</h2>
        <div id="oauth-config"></div>
        <button onclick="checkOAuthConfig()">æ£€æŸ¥OAuthé…ç½®</button>
    </div>

    <div class="card">
        <h2>3. ç™»å½•æµ‹è¯•</h2>
        <div id="login-test"></div>
        <button onclick="testLogin()">æµ‹è¯•GitHubç™»å½•</button>
        <button onclick="testManualAuth()">æ‰‹åŠ¨æµ‹è¯•æˆæƒ</button>
    </div>

    <div class="card">
        <h2>4. ç½‘ç»œè¿æ¥æµ‹è¯•</h2>
        <div id="network-test"></div>
        <button onclick="testNetwork()">æµ‹è¯•ç½‘ç»œè¿æ¥</button>
    </div>

    <div class="card">
        <h2>5. è°ƒè¯•ä¿¡æ¯</h2>
        <div id="debug-info"></div>
        <button onclick="showDebugInfo()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯
        const GITHUB_CONFIG = {
            clientId: 'Ov23lipRjGjVWDKrIQze',
            redirectUri: 'https://zhangshr8.github.io/calendar',
            scope: 'repo'
        };

        // æ—¥å¿—å‡½æ•°
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML += `<div class="${type}">${message}</div>`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // æ£€æŸ¥åŸºç¡€ä¿¡æ¯
        function checkBasicInfo() {
            clearLog('basic-info');
            log('basic-info', 'ğŸ” æ£€æŸ¥åŸºç¡€ä¿¡æ¯...', 'info');
            
            // æ£€æŸ¥å½“å‰URL
            log('basic-info', `å½“å‰URL: ${window.location.href}`, 'info');
            
            // æ£€æŸ¥URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (code) {
                log('basic-info', `âœ… å‘ç°æˆæƒç : ${code.substring(0, 10)}...`, 'success');
            } else if (error) {
                log('basic-info', `âŒ å‘ç°é”™è¯¯: ${error}`, 'error');
                const errorDesc = urlParams.get('error_description');
                if (errorDesc) {
                    log('basic-info', `é”™è¯¯æè¿°: ${decodeURIComponent(errorDesc)}`, 'error');
                }
            } else {
                log('basic-info', 'â„¹ï¸ æœªå‘ç°æˆæƒç æˆ–é”™è¯¯', 'info');
            }
            
            // æ£€æŸ¥localStorage
            const token = localStorage.getItem('github_token');
            const user = localStorage.getItem('github_user');
            
            if (token) {
                log('basic-info', 'âœ… æ‰¾åˆ°GitHub token', 'success');
            } else {
                log('basic-info', 'âŒ æœªæ‰¾åˆ°GitHub token', 'error');
            }
            
            if (user) {
                log('basic-info', 'âœ… æ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯', 'success');
            } else {
                log('basic-info', 'âŒ æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯', 'error');
            }
        }

        // æ£€æŸ¥OAuthé…ç½®
        function checkOAuthConfig() {
            clearLog('oauth-config');
            log('oauth-config', 'ğŸ” æ£€æŸ¥OAuthé…ç½®...', 'info');
            
            log('oauth-config', `Client ID: ${GITHUB_CONFIG.clientId}`, 'info');
            log('oauth-config', `Redirect URI: ${GITHUB_CONFIG.redirectUri}`, 'info');
            log('oauth-config', `Scope: ${GITHUB_CONFIG.scope}`, 'info');
            
            // éªŒè¯é…ç½®
            if (!GITHUB_CONFIG.clientId || GITHUB_CONFIG.clientId === 'YOUR_CLIENT_ID') {
                log('oauth-config', 'âŒ Client IDæœªé…ç½®', 'error');
            } else {
                log('oauth-config', 'âœ… Client IDå·²é…ç½®', 'success');
            }
            
            if (!GITHUB_CONFIG.redirectUri || GITHUB_CONFIG.redirectUri === 'YOUR_REDIRECT_URI') {
                log('oauth-config', 'âŒ Redirect URIæœªé…ç½®', 'error');
            } else {
                log('oauth-config', 'âœ… Redirect URIå·²é…ç½®', 'success');
            }
        }

        // æµ‹è¯•ç™»å½•
        function testLogin() {
            clearLog('login-test');
            log('login-test', 'ğŸ” æµ‹è¯•GitHubç™»å½•...', 'info');
            
            // æ„å»ºOAuth URL
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CONFIG.clientId}&redirect_uri=${encodeURIComponent(GITHUB_CONFIG.redirectUri)}&scope=${GITHUB_CONFIG.scope}`;
            
            log('login-test', `OAuth URL: ${authUrl}`, 'info');
            log('login-test', 'ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥æ‰‹åŠ¨æµ‹è¯•:', 'info');
            
            const link = document.createElement('a');
            link.href = authUrl;
            link.textContent = 'ç‚¹å‡»è¿™é‡Œè¿›è¡ŒGitHubæˆæƒ';
            link.target = '_blank';
            link.style.display = 'block';
            link.style.margin = '10px 0';
            link.style.padding = '10px';
            link.style.background = '#007bff';
            link.style.color = 'white';
            link.style.textDecoration = 'none';
            link.style.borderRadius = '5px';
            link.style.textAlign = 'center';
            
            document.getElementById('login-test').appendChild(link);
        }

        // æ‰‹åŠ¨æµ‹è¯•æˆæƒ
        function testManualAuth() {
            clearLog('login-test');
            log('login-test', 'ğŸ” æ‰‹åŠ¨æµ‹è¯•æˆæƒæµç¨‹...', 'info');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æˆæƒç 
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                log('login-test', `âœ… å‘ç°æˆæƒç : ${code}`, 'success');
                testTokenExchange(code);
            } else {
                log('login-test', 'âŒ æœªå‘ç°æˆæƒç ï¼Œè¯·å…ˆè¿›è¡Œæˆæƒ', 'error');
                log('login-test', 'è¯·ç‚¹å‡»"æµ‹è¯•GitHubç™»å½•"æŒ‰é’®è·å–æˆæƒç ', 'info');
            }
        }

        // æµ‹è¯•tokenäº¤æ¢
        async function testTokenExchange(code) {
            log('login-test', 'ğŸ” æµ‹è¯•tokenäº¤æ¢...', 'info');
            
            try {
                const response = await fetch('https://github.com/login/oauth/access_token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: GITHUB_CONFIG.clientId,
                        client_secret: 'cc563e335e3f23ecdd19c7d4eaae65534483c486',
                        code: code,
                        redirect_uri: GITHUB_CONFIG.redirectUri
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('login-test', 'âœ… Tokenäº¤æ¢æˆåŠŸ', 'success');
                    log('login-test', `Token: ${data.access_token.substring(0, 10)}...`, 'success');
                    log('login-test', `Tokenç±»å‹: ${data.token_type}`, 'success');
                    log('login-test', `Scope: ${data.scope}`, 'success');
                    
                    // æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯
                    await testUserInfo(data.access_token);
                } else {
                    log('login-test', `âŒ Tokenäº¤æ¢å¤±è´¥: ${data.error}`, 'error');
                    if (data.error_description) {
                        log('login-test', `é”™è¯¯æè¿°: ${data.error_description}`, 'error');
                    }
                }
            } catch (error) {
                log('login-test', `âŒ Tokenäº¤æ¢è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯
        async function testUserInfo(token) {
            log('login-test', 'ğŸ” æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯...', 'info');
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    log('login-test', 'âœ… ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ', 'success');
                    log('login-test', `ç”¨æˆ·å: ${user.login}`, 'success');
                    log('login-test', `å§“å: ${user.name || 'æœªè®¾ç½®'}`, 'success');
                    log('login-test', `é‚®ç®±: ${user.email || 'æœªè®¾ç½®'}`, 'success');
                    log('login-test', `å¤´åƒ: ${user.avatar_url}`, 'success');
                } else {
                    log('login-test', `âŒ ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log('login-test', `âŒ ç”¨æˆ·ä¿¡æ¯è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•ç½‘ç»œè¿æ¥
        async function testNetwork() {
            clearLog('network-test');
            log('network-test', 'ğŸ” æµ‹è¯•ç½‘ç»œè¿æ¥...', 'info');
            
            // æµ‹è¯•GitHub API
            try {
                const response = await fetch('https://api.github.com/rate_limit');
                if (response.ok) {
                    log('network-test', 'âœ… GitHub APIè¿æ¥æ­£å¸¸', 'success');
                    const data = await response.json();
                    log('network-test', `APIé™åˆ¶: ${data.rate.remaining}/${data.rate.limit}`, 'info');
                } else {
                    log('network-test', `âŒ GitHub APIè¿æ¥å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log('network-test', `âŒ ç½‘ç»œè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
            
            // æµ‹è¯•OAuthç«¯ç‚¹
            try {
                const response = await fetch('https://github.com/login/oauth/authorize', {
                    method: 'HEAD'
                });
                if (response.ok) {
                    log('network-test', 'âœ… OAuthç«¯ç‚¹è¿æ¥æ­£å¸¸', 'success');
                } else {
                    log('network-test', `âŒ OAuthç«¯ç‚¹è¿æ¥å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log('network-test', `âŒ OAuthç«¯ç‚¹è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugInfo() {
            clearLog('debug-info');
            log('debug-info', 'ğŸ” è°ƒè¯•ä¿¡æ¯:', 'info');
            log('debug-info', `User Agent: ${navigator.userAgent}`, 'info');
            log('debug-info', `å½“å‰æ—¶é—´: ${new Date().toISOString()}`, 'info');
            log('debug-info', `é¡µé¢URL: ${window.location.href}`, 'info');
            log('debug-info', `é¡µé¢åè®®: ${window.location.protocol}`, 'info');
            log('debug-info', `é¡µé¢ä¸»æœº: ${window.location.host}`, 'info');
            log('debug-info', `é¡µé¢è·¯å¾„: ${window.location.pathname}`, 'info');
            
            // æ˜¾ç¤ºæ‰€æœ‰URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            log('debug-info', 'URLå‚æ•°:', 'info');
            for (const [key, value] of urlParams) {
                log('debug-info', `  ${key}: ${value}`, 'info');
            }
            
            // æ˜¾ç¤ºlocalStorageå†…å®¹
            log('debug-info', 'LocalStorageå†…å®¹:', 'info');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                if (key.includes('github') || key.includes('token')) {
                    log('debug-info', `  ${key}: ${value.substring(0, 20)}...`, 'info');
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkBasicInfo();
            checkOAuthConfig();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error) {
                alert(`OAuthé”™è¯¯: ${error}\næè¿°: ${urlParams.get('error_description') || 'æ— '}`);
            }
        };
    </script>
</body>
</html>